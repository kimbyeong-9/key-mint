// Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ (ìƒì„¸ ë””ë²„ê¹…)
console.log('ğŸ” Supabase í™˜ê²½ ë³€ìˆ˜ í™•ì¸:');
console.log('  URL:', supabaseUrl);
console.log('  URL íƒ€ì…:', typeof supabaseUrl);
console.log('  Key ê¸¸ì´:', supabaseAnonKey?.length || 0);
console.log('  Key ì• 20ì:', supabaseAnonKey?.substring(0, 20));
console.log('  ëª¨ë“  í™˜ê²½ ë³€ìˆ˜:', import.meta.env);

if (!supabaseUrl || !supabaseAnonKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
  console.error('VITE_SUPABASE_URL:', supabaseUrl);
  console.error('VITE_SUPABASE_ANON_KEY:', supabaseAnonKey ? 'ìˆìŒ' : 'ì—†ìŒ');
}

// Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
let supabase = null;

if (supabaseUrl && supabaseAnonKey) {
  try {
    supabase = createClient(supabaseUrl, supabaseAnonKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
    });

    // ì „ì—­ ê°ì²´ì— ë“±ë¡ (ë””ë²„ê¹…ìš©)
    if (typeof window !== 'undefined') {
      window.supabase = supabase;
    }

    console.log(' Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
  } catch (error) {
    console.error(' Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
}

export { supabase };

// ===== AUTHENTICATION í•¨ìˆ˜ë“¤ =====

/**
 * íšŒì›ê°€ì…
 */
export async function signUpWithEmail(userData, metadata = {}) {
  if (!supabase) {
    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  const username = metadata.username || userData.username;

  const { data, error } = await supabase.auth.signUp({
    email: userData.email,
    password: userData.password,
    options: {
      data: {
        username: username,
        full_name: username,
        display_name: username,
        wallet_address: metadata.address || userData.address || null,
        is_web3_user: !!(metadata.address || userData.address),
      }
    }
  });

  if (error) {
    if (error.message.includes('User already registered')) {
      throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
    }
    throw error;
  }

  if (!data.user) {
    throw new Error('íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }

  console.log('íšŒì›ê°€ì… ì„±ê³µ:', data.user.email);
  return data;
}

/**
 * ë¡œê·¸ì¸
 */
export async function signInWithEmail(email, password) {
  if (!supabase) {
    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  const { data, error } = await supabase.auth.signInWithPassword({
    email: email,
    password: password,
  });

  if (error) {
    if (error.message.includes('Invalid login credentials')) {
      throw new Error('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
    if (error.message.includes('Email not confirmed')) {
      throw new Error('ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    }
    throw error;
  }

  if (!data.user) {
    throw new Error('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }

  console.log('ë¡œê·¸ì¸ ì„±ê³µ:', data.user.email);
  return data;
}

/**
 * ë¡œê·¸ì•„ì›ƒ
 */
export async function signOut() {
  if (!supabase) {
    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  const { error } = await supabase.auth.signOut();

  if (error) {
    throw error;
  }

  console.log(' ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
  return true;
}

/**
 * í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
 */
export async function getCurrentUser() {
  if (!supabase) {
    return null;
  }

  const { data: { user }, error } = await supabase.auth.getUser();

  if (error) {
    console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    return null;
  }

  return user;
}

/**
 * Auth ìƒíƒœ ë³€ê²½ ê°ì§€
 */
export function onAuthStateChange(callback) {
  if (!supabase) {
    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  return supabase.auth.onAuthStateChange(callback);
}

/**
 * ì‚¬ìš©ì ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
 */
export async function updateUserMetadata(updates) {
  if (!supabase) {
    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  const { data, error } = await supabase.auth.updateUser({
    data: updates
  });

  if (error) {
    throw error;
  }

  return data;
}

/**
 * ì‚¬ìš©ìëª… ì¤‘ë³µ í™•ì¸
 * í˜•ì‹ ê²€ì¦ (ì‹¤ì œ ì¤‘ë³µì€ íšŒì›ê°€ì… ì‹œ í™•ì¸ë¨)
 */
export async function checkUsernameAvailable(username) {
  try {
    // ì‚¬ìš©ìëª… í˜•ì‹ ê²€ì¦
    if (!username || username.length < 2) {
      return {
        available: false,
        message: 'ì‚¬ìš©ìëª…ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'
      };
    }

    if (username.length > 20) {
      return {
        available: false,
        message: 'ì‚¬ìš©ìëª…ì€ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.'
      };
    }

    if (!/^[a-zA-Z0-9ê°€-í£_]+$/.test(username)) {
      return {
        available: false,
        message: 'ì‚¬ìš©ìëª…ì€ ì˜ë¬¸, í•œê¸€, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
      };
    }

    // í˜•ì‹ì´ ì˜¬ë°”ë¥´ë©´ ì‚¬ìš© ê°€ëŠ¥ìœ¼ë¡œ í‘œì‹œ
    // ì‹¤ì œ ì¤‘ë³µì€ íšŒì›ê°€ì… ì‹œ Supabaseì—ì„œ í™•ì¸ë¨
    return {
      available: true,
      message: 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ í˜•ì‹ì…ë‹ˆë‹¤.'
    };

  } catch (error) {
    console.error('âŒ ì‚¬ìš©ìëª… í™•ì¸ ì‹¤íŒ¨:', error);
    return {
      available: false,
      message: 'ì‚¬ìš©ìëª… í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    };
  }
}

/**
 * ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
 * í˜•ì‹ ê²€ì¦ (ì‹¤ì œ ì¤‘ë³µì€ íšŒì›ê°€ì… ì‹œ í™•ì¸ë¨)
 */
export async function checkEmailAvailable(email) {
  try {
    // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      return {
        available: false,
        message: 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      };
    }

    // í˜•ì‹ì´ ì˜¬ë°”ë¥´ë©´ ì‚¬ìš© ê°€ëŠ¥ìœ¼ë¡œ í‘œì‹œ
    // ì‹¤ì œ ì¤‘ë³µì€ íšŒì›ê°€ì… ì‹œ Supabaseì—ì„œ í™•ì¸ë¨
    return {
      available: true,
      message: 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ í˜•ì‹ì…ë‹ˆë‹¤.'
    };

  } catch (error) {
    console.error('âŒ ì´ë©”ì¼ í™•ì¸ ì‹¤íŒ¨:', error);
    return {
      available: false,
      message: 'ì´ë©”ì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    };
  }
}
